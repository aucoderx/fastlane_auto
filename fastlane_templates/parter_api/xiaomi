#!/bin/bash

set -e

XIAOMI_USERNAME="${XIAOMI_USERNAME}"  # 小米开发者邮箱
XIAOMI_PRIVATE_KEY="${XIAOMI_PRIVATE_KEY}"  # 小米私钥
XIAOMI_PUBLIC_KEY="${XIAOMI_PUBLIC_KEY}"  # 小米公钥文件路径

# 应用相关参数
APP_NAME={{APP_NAME}}
PACKAGE_NAME={{ANDROID_PACKAGE_NAME}}
PUBLISHER_NAME="${PUBLISHER_NAME:-}"
VERSION_NAME={{APP_VERSION}}
CATEGORY={{APP_CATEGORY}}  # 应用分类ID
KEYWORDS={{APP_KEYWORDS}}
APP_DESC={{APP_DESCRIPTION}}
UPDATE_DESC="${UPDATE_DESC:-}"
APP_BRIEF="${APP_BRIEF}"
PRIVACY_URL="${PRIVACY_URL}"
TEST_ACCOUNT="${TEST_ACCOUNT:-}"
SYNCHRO_TYPE="${SYNCHRO_TYPE:-0}"  # 0=新增，1=更新包，2=内容更新
ONLINE_TIME="${ONLINE_TIME:-}"

# 文件路径
APK_PATH="${APK_PATH}"
ICON_PATH="${ICON_PATH}"
SCREENSHOT_1="${SCREENSHOT_1}"
SCREENSHOT_2="${SCREENSHOT_2}"
SCREENSHOT_3="${SCREENSHOT_3}"
SCREENSHOT_4="${SCREENSHOT_4:-}"
SCREENSHOT_5="${SCREENSHOT_5:-}"

# API地址
BASE_URL="https://api.developer.xiaomi.com/devupload"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 日志函数
log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# 检查必需参数
check_required_params() {
    log "检查必需参数..."
    
    [ -z "$XIAOMI_USERNAME" ] && error "XIAOMI_USERNAME 未设置"
    [ -z "$XIAOMI_PRIVATE_KEY" ] && error "XIAOMI_PRIVATE_KEY 未设置"
    [ -z "$APP_NAME" ] && error "APP_NAME 未设置"
    [ -z "$PACKAGE_NAME" ] && error "PACKAGE_NAME 未设置"
    [ -z "$APK_PATH" ] && error "APK_PATH 未设置"
    [ -z "$ICON_PATH" ] && error "ICON_PATH 未设置"
    [ -z "$PRIVACY_URL" ] && error "PRIVACY_URL 未设置"
    
    # 检查文件是否存在
    [ ! -f "$APK_PATH" ] && error "APK文件不存在: $APK_PATH"
    [ ! -f "$ICON_PATH" ] && error "图标文件不存在: $ICON_PATH"
    
    if [ "$SYNCHRO_TYPE" = "0" ]; then
        [ -z "$CATEGORY" ] && error "新增应用时CATEGORY必须设置"
        [ -z "$KEYWORDS" ] && error "新增应用时KEYWORDS必须设置"
        [ -z "$APP_DESC" ] && error "新增应用时APP_DESC必须设置"
        [ -z "$APP_BRIEF" ] && error "新增应用时APP_BRIEF必须设置"
        [ -z "$SCREENSHOT_1" ] && error "新增应用时SCREENSHOT_1必须设置"
        [ -z "$SCREENSHOT_2" ] && error "新增应用时SCREENSHOT_2必须设置"
        [ -z "$SCREENSHOT_3" ] && error "新增应用时SCREENSHOT_3必须设置"
        
        [ ! -f "$SCREENSHOT_1" ] && error "截图1不存在: $SCREENSHOT_1"
        [ ! -f "$SCREENSHOT_2" ] && error "截图2不存在: $SCREENSHOT_2"
        [ ! -f "$SCREENSHOT_3" ] && error "截图3不存在: $SCREENSHOT_3"
    fi
    
    if [ "$SYNCHRO_TYPE" = "1" ]; then
        [ -z "$UPDATE_DESC" ] && error "更新应用时UPDATE_DESC必须设置"
    fi
    
    log "参数检查完成"
}

# 计算文件MD5
calculate_md5() {
    local file_path="$1"
    if command -v md5sum >/dev/null 2>&1; then
        md5sum "$file_path" | cut -d' ' -f1
    elif command -v md5 >/dev/null 2>&1; then
        md5 -q "$file_path"
    else
        error "未找到 md5sum 或 md5 命令"
    fi
}

# 生成SIG签名
generate_sig() {
    local request_data="$1"
    local sig_files=("$@")
    sig_files=("${sig_files[@]:1}")  # 移除第一个参数
    
    log "生成数字签名..."
    
    # 计算RequestData的MD5
    local request_data_md5=$(echo -n "$request_data" | md5sum | cut -d' ' -f1 2>/dev/null || echo -n "$request_data" | md5)
    
    # 构建sig数组
    local sig_json='{"sig":['
    sig_json+="{\"name\":\"RequestData\",\"hash\":\"$request_data_md5\"}"
    
    # 添加文件MD5
    for file_info in "${sig_files[@]}"; do
        IFS='|' read -r param_name file_path <<< "$file_info"
        if [ -n "$file_path" ] && [ -f "$file_path" ]; then
            local file_md5=$(calculate_md5 "$file_path")
            sig_json+=",{\"name\":\"$param_name\",\"hash\":\"$file_md5\"}"
        fi
    done
    
    sig_json+="],"
    sig_json+="\"password\":\"$XIAOMI_PRIVATE_KEY\"}"
    
    # 使用OpenSSL进行RSA签名
    local sig_result
    if [ -f "$XIAOMI_PUBLIC_KEY" ]; then
        sig_result=$(echo -n "$sig_json" | openssl rsautl -sign -inkey "$XIAOMI_PUBLIC_KEY" | base64 -w 0)
    else
        # 如果没有公钥文件，使用私钥直接签名（需要根据实际情况调整）
        warn "未找到公钥文件，请确保XIAOMI_PUBLIC_KEY路径正确"
        # 这里需要根据实际的加密方式调整
        sig_result=$(echo -n "$sig_json" | openssl dgst -sha256 -sign <(echo "$XIAOMI_PRIVATE_KEY") | base64 -w 0)
    fi
    
    echo "$sig_result"
}

# 推送应用
push_app() {
    log "准备推送应用到小米应用商店..."
    
    # 构建appInfo
    local app_info="{\"appName\":\"$APP_NAME\",\"packageName\":\"$PACKAGE_NAME\",\"suitableType\":0"
    [ -n "$PUBLISHER_NAME" ] && app_info+=",\"publisherName\":\"$PUBLISHER_NAME\""
    [ -n "$VERSION_NAME" ] && app_info+=",\"versionName\":\"$VERSION_NAME\""
    [ -n "$CATEGORY" ] && app_info+=",\"category\":$CATEGORY"
    [ -n "$KEYWORDS" ] && app_info+=",\"keyWords\":\"$KEYWORDS\""
    [ -n "$APP_DESC" ] && app_info+=",\"desc\":\"$APP_DESC\""
    [ -n "$UPDATE_DESC" ] && app_info+=",\"updateDesc\":\"$UPDATE_DESC\""
    [ -n "$APP_BRIEF" ] && app_info+=",\"brief\":\"$APP_BRIEF\""
    [ -n "$PRIVACY_URL" ] && app_info+=",\"privacyUrl\":\"$PRIVACY_URL\""
    [ -n "$TEST_ACCOUNT" ] && app_info+=",\"testAccount\":\"$TEST_ACCOUNT\""
    [ -n "$ONLINE_TIME" ] && app_info+=",\"onlineTime\":$ONLINE_TIME"
    app_info+="}"
    
    # 构建RequestData
    local request_data="{\"userName\":\"$XIAOMI_USERNAME\",\"synchroType\":$SYNCHRO_TYPE,\"appInfo\":$app_info}"
    
    # 准备文件参数
    local sig_files=()
    local curl_params=()
    
    # 添加APK
    if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
        sig_files+=("apk|$APK_PATH")
        curl_params+=("--form" "apk=@$APK_PATH")
    fi
    
    # 添加图标
    sig_files+=("icon|$ICON_PATH")
    curl_params+=("--form" "icon=@$ICON_PATH")
    
    # 添加截图
    local screenshots=("screenshot_1|$SCREENSHOT_1" "screenshot_2|$SCREENSHOT_2" "screenshot_3|$SCREENSHOT_3" "screenshot_4|$SCREENSHOT_4" "screenshot_5|$SCREENSHOT_5")
    for screenshot in "${screenshots[@]}"; do
        IFS='|' read -r param_name file_path <<< "$screenshot"
        if [ -n "$file_path" ] && [ -f "$file_path" ]; then
            sig_files+=("$screenshot")
            curl_params+=("--form" "$param_name=@$file_path")
        fi
    done
    
    # 生成签名
    local sig=$(generate_sig "$request_data" "${sig_files[@]}")
    
    log "开始上传..."
    
    # 执行上传
    local response=$(curl -s --location "${BASE_URL}/dev/push" \
        --form "RequestData=$request_data" \
        --form "SIG=$sig" \
        "${curl_params[@]}")
    
    echo "$response"
}

# 解析响应结果
parse_response() {
    local response="$1"
    local operation="$2"
    
    if [ -z "$response" ]; then
        error "API响应为空"
    fi
    
    # 检查是否为有效JSON
    if ! echo "$response" | python3 -m json.tool >/dev/null 2>&1; then
        error "API响应不是有效的JSON: $response"
    fi
    
    # 提取result字段
    local result=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('result', -1))")
    local message=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('message', ''))")
    
    if [ "$result" = "0" ]; then
        log "${operation}成功: $message"
        return 0
    else
        error "${operation}失败 (错误码: $result): $message"
    fi
}

# 主函数
main() {
    log "开始小米应用商店上传流程..."
    
    # 检查必需参数
    check_required_params
    
    # 推送应用
    local push_response=$(push_app)
    parse_response "$push_response" "应用推送"
    
    log "小米应用商店上传完成！"
}

# 执行主函数
main "$@"