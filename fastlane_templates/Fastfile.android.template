default_platform(:android)

platform :android do
  desc "è¿è¡Œæ‰€æœ‰æµ‹è¯•"
  lane :test do
    gradle(task: "test")
  end

  lane :launch_emulator do |options|
    avd_name = options[:avd] || "Medium_Phone_API_36.0"
    UI.message("â¡ï¸ å‡†å¤‡å¯åŠ¨ Android æ¨¡æ‹Ÿå™¨ï¼š#{avd_name}")

    existing_devices = `adb devices`.lines.select { |line| line.include?("device") && !line.include?("List of devices") }

    if existing_devices.empty?
      emulator_cmd = [
        "emulator", "-avd", avd_name,
        "-no-audio", "-no-boot-anim", "-netdelay", "none", "-netspeed", "full"
      ]

      UI.message("ğŸš€ æ­£åœ¨åå°å¯åŠ¨æ¨¡æ‹Ÿå™¨ï¼š#{emulator_cmd.join(" ")}")

      pid = Process.spawn(*emulator_cmd, [:out, :err] => "/tmp/emulator_output.log")
      Process.detach(pid)

      UI.message("â³ ç­‰å¾…è®¾å¤‡å¯åŠ¨å¹¶è¿æ¥...")

      sh("adb wait-for-device")
      sh("adb shell getprop sys.boot_completed | grep 1")

      device_ready = false
      max_attempts = 30

      max_attempts.times do |i|
        sleep(5)
        devices_output = `adb devices 2>/dev/null`.strip
        devices_lines = devices_output.lines

        online_devices = devices_lines.select do |line|
          line.strip.end_with?("device") && !line.include?("List of devices")
        end

        if online_devices.any?
          device_ready = true
          UI.success("âœ… è®¾å¤‡å·²è¿æ¥ï¼æ£€æµ‹åˆ°è®¾å¤‡ï¼š")
          online_devices.each { |device| UI.message("   #{device.strip}") }
          break
        else
          UI.message("âŒ› è®¾å¤‡å°šæœªå‡†å¤‡å¥½ï¼ˆå°è¯•ç¬¬ #{i + 1}/#{max_attempts} æ¬¡ï¼‰")
          UI.message("   å½“å‰ adb devices è¾“å‡ºï¼š#{devices_output}")
        end
      end

      unless device_ready
        UI.user_error!("âŒ å¯åŠ¨æ¨¡æ‹Ÿå™¨å¤±è´¥æˆ–æœªæ£€æµ‹åˆ°è®¾å¤‡ã€‚è¯·æ£€æŸ¥ï¼š
          1. AVD '#{avd_name}' æ˜¯å¦å­˜åœ¨
          2. Android SDK è·¯å¾„æ˜¯å¦æ­£ç¡®
          3. æ¨¡æ‹Ÿå™¨æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç³»ç»Ÿèµ„æº")
      end
    else
      UI.success("âœ… æ£€æµ‹åˆ°å·²æœ‰è®¾å¤‡åœ¨è¿è¡Œ")
      existing_devices.each { |device| UI.message("   #{device.strip}") }
    end

    UI.message("ğŸ”„ ç­‰å¾…è®¾å¤‡å®Œå…¨å¯åŠ¨...")
    sleep(10)

    begin
      sh("adb shell getprop sys.boot_completed")
      UI.success("ğŸ“± è®¾å¤‡å¯åŠ¨å®Œæˆ")
    rescue
      UI.message("âš ï¸  è®¾å¤‡å¯èƒ½å°šæœªå®Œå…¨å¯åŠ¨ï¼Œç»§ç»­å°è¯•...")
    end
  end

  desc "è¿è¡Œæˆªå±æµ‹è¯•ï¼ˆè‡ªåŠ¨å¯åŠ¨æ¨¡æ‹Ÿå™¨å¹¶ç­‰å¾…è®¾å¤‡å¯ç”¨ï¼‰"
  lane :screenshots do |options|
    UI.message("ğŸš€ å¼€å§‹è¿è¡Œæˆªå›¾æµ‹è¯•...")

    serial = options[:serial]
    if serial
      ENV["ANDROID_SERIAL"] = serial
      UI.message("ğŸ“² è¿è¡Œæˆªå›¾æµ‹è¯•äºæŒ‡å®šè®¾å¤‡ï¼š#{serial}")
    else
      UI.message("âš ï¸ æœªæŒ‡å®šè®¾å¤‡ serialï¼Œscreengrab å°†ä½¿ç”¨ adb åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªè®¾å¤‡")
    end

    # æ„å»ºæµ‹è¯• APKï¼ˆä¸» app å’Œ androidTestï¼‰
    build_debug

    screengrab(
      app_package_name: "{{ANDROID_PACKAGE_NAME}}", # ä½ çš„å®é™…åŒ…å
      locales: ["zh-CN", "en-US"], 
      tests_package_name: "{{ANDROID_PACKAGE_NAME}}.test",
      app_apk_path: "app/build/outputs/apk/debug/app-debug.apk", # âœ… æ˜ç¡®æŒ‡å®š APK
      tests_apk_path: "app/build/outputs/apk/debug/app-debug.apk",
      clear_previous_screenshots: true
    )

    UI.success("ğŸ‰ æˆªå›¾æµ‹è¯•å®Œæˆ")
  end

  desc "Run detox tests and collect screenshots"
  lane :e2e_screenshots do
    sh("cd ../.. && npx detox build --configuration android.emu.debug")
    sh("cd ../.. && npx detox test --configuration android.emu.debug --loglevel trace")
    
    sh("mkdir -p metadata/en-US/images/phoneScreenshots")
    sh("mkdir -p metadata/zh-CN/images/phoneScreenshots")

    sh("cd ../.. && cp artifacts/*/*/android_*.png android/fastlane/metadata/android/en-US/images/phoneScreenshots/")
    sh("cd ../.. && cp artifacts/*/*/android_*.png android/fastlane/metadata/android/zh-CN/images/phoneScreenshots/")

    # åˆ é™¤åŸç›®å½•ä¸‹çš„å›¾ç‰‡
    sh("cd ../.. && rm -rf artifacts/*/*/android_*.png")

  end

  desc "Run detox tests and collect screenshots"
  lane :e2e_screenshots_all_platform do
    # æ‰‹æœº
    sh("cd ../.. && detox test --configuration android.emu.debug")
    
    sh("cd ../.. && cp artifacts/*/*/android_*.png android/fastlane/metadata/android/en-US/images/phoneScreenshots/")
    sh("cd ../.. && cp artifacts/*/*/android_*.png android/fastlane/metadata/android/zh-CN/images/phoneScreenshots/")

    # åˆ é™¤åŸç›®å½•ä¸‹çš„å›¾ç‰‡
    sh("cd ../.. && rm -rf artifacts/*/*/android_*.png")

    # 7 å¯¸å¹³æ¿
    sh("cd ../.. && detox test --configuration android.emu.debug.tablet7")
    
    sh("cd ../.. && cp artifacts/*/*/android_*.png android/fastlane/metadata/android/en-US/images/sevenInchScreenshots/")
    sh("cd ../.. && cp artifacts/*/*/android_*.png android/fastlane/metadata/android/zh-CN/images/sevenInchScreenshots/")

    # åˆ é™¤åŸç›®å½•ä¸‹çš„å›¾ç‰‡
    sh("cd ../.. && rm -rf artifacts/*/*/android_*.png")

    # 10 å¯¸å¹³æ¿
    sh("cd ../.. && detox test --configuration android.emu.debug.tablet10")
    
    sh("cd ../.. && cp artifacts/*/*/android_*.png android/fastlane/metadata/android/en-US/images/tenInchScreenshots/")
    sh("cd ../.. && cp artifacts/*/*/android_*.png android/fastlane/metadata/android/zh-CN/images/tenInchScreenshots/")

    # åˆ é™¤åŸç›®å½•ä¸‹çš„å›¾ç‰‡
    sh("cd ../.. && rm -rf artifacts/*/*/android_*.png")

  end

  desc "å…³é—­æŒ‡å®š Android æ¨¡æ‹Ÿå™¨ï¼Œä¼ å…¥ serialï¼Œå¦‚ emulator-5554"
  lane :shutdown_emulator do |options|
    serial = options[:serial]
    unless serial
      UI.user_error!("âŒ ç¼ºå°‘å‚æ•°ï¼šè¯·ä¼ å…¥ serialï¼Œä¾‹å¦‚ï¼šserial:\"emulator-5554\"")
    end

    UI.message("ğŸ›‘ æ­£åœ¨å…³é—­æ¨¡æ‹Ÿå™¨ï¼š#{serial}")
    begin
      sh("adb -s #{serial} emu kill")
      UI.success("âœ… æ¨¡æ‹Ÿå™¨ #{serial} å·²å…³é—­")
    rescue
      UI.user_error!("âŒ æ— æ³•å…³é—­æ¨¡æ‹Ÿå™¨ #{serial}ï¼Œè¯·ç¡®è®¤ serial æ˜¯å¦æ­£ç¡®")
    end
  end

  desc "å¯åŠ¨æ¨¡æ‹Ÿå™¨ + æˆªå›¾ + å…³é—­æ¨¡æ‹Ÿå™¨ï¼ˆå®Œæ•´æµç¨‹ï¼‰"
  lane :full_screenshot_flow do |options|
    avd = options[:avd] || "Medium_Phone_API_36.0"

    # å¯åŠ¨æ¨¡æ‹Ÿå™¨å¹¶è·å– serial
    launch_emulator(avd: avd)

    # è·å–åˆšåˆšå¯åŠ¨çš„ emulator serialï¼ˆå‡è®¾åªæœ‰ä¸€ä¸ªæ–° emulator å¯åŠ¨ï¼‰
    emulator_serial = `adb devices`.lines.find { |line| line.start_with?("emulator-") && line.include?("device") }&.split&.first

    if emulator_serial.nil?
      UI.user_error!("âŒ æœªæ‰¾åˆ°å·²è¿æ¥çš„æ¨¡æ‹Ÿå™¨")
    end

    # è¿è¡Œæˆªå›¾é€»è¾‘
    run_screengrab(serial: emulator_serial)

    # å…³é—­æ¨¡æ‹Ÿå™¨
    shutdown_emulator(serial: emulator_serial)
  end

  desc "æ„å»ºåº”ç”¨"
  lane :build do
    gradle(
      task: "clean assembleRelease",
      project_dir: "."
    )
  end

  desc "æ„å»º AAB"
  lane :build_aab do
    gradle(
      task: "clean bundleRelease",
      project_dir: "."
    )
  end

  # æ‰“ debug åŒ…çš„ lane
  lane :build_debug do
    gradle(
      task: "assembleDebug assembleDebugAndroidTest",
      project_dir: "."
    )
  end

  # ä¿®æ”¹å‘å¸ƒçŠ¶æ€çš„ lane
  desc "å°†å‘å¸ƒçŠ¶æ€ä¿®æ”¹ä¸º 'completed'ï¼Œå¦‚æœå¤±è´¥åˆ™ç»™å‡ºæç¤º"
  lane :change_release_status_to_completed do
    begin
      track = options[:track]
      upload_to_play_store(
        track: track,
        version_code: {{APP_VERSION}},
        release_status: "completed",
        skip_upload_apk: true
      )
    rescue => e
      UI.message("Failed to change release status to 'completed': #{e.message}. The app is still in 'draft' state.")
    end
  end

  desc "ä¸Šä¼ åˆ°å†…éƒ¨æµ‹è¯•ï¼Œæœ€å¿«é€Ÿå‘å¸ƒç»™æµ‹è¯•äººå‘˜ï¼Œæœ€å¤š 100 ä½æµ‹è¯•è€…ã€‚"
  lane :internal do
    build_aab

    upload_to_play_store(
      track: "internal",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      version_code: {{APP_VERSION}},
      release_status: "draft",
      skip_upload_apk: true
    )

    change_release_status_to_completed(track: "internal")
  end

  desc "ä¸Šä¼ åˆ°å°é—­æµ‹è¯•ï¼Œé€‚åˆå°èŒƒå›´æµ‹è¯•ç”¨æˆ·ã€‚"
  lane :alpha do
    build_aab

    upload_to_play_store(
      track: "alpha",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      version_code: {{APP_VERSION}},
      release_status: "draft",
      skip_upload_apk: true
    )

    change_release_status_to_completed(track: "alpha")
  end

  desc "å°é—­æˆ–å…¬å¼€æµ‹è¯•è½¨é“ï¼Œç”¨æˆ·ç¾¤ä½“æ¯” alpha å¤§ã€‚"
  lane :beta do
    build_aab

    upload_to_play_store(
      track: "beta",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      version_code: {{APP_VERSION}},
      release_status: "draft",
      skip_upload_apk: true
    )

    change_release_status_to_completed(track: "beta")
  end

  desc "å‘å¸ƒåˆ° Google Play Store"
  lane :release do
    build_aab

    upload_to_play_store(
      track: "production",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      version_code: {{APP_VERSION}},
      release_status: "completed",
      skip_upload_apk: true,
    )
  end
end

# ç»Ÿä¸€çš„ after_all é…ç½®
after_all do |lane|
  notification(message: "Fastlane finished '#{lane}' successfully! ğŸ‰")
end
