name: Expo IOS Build and Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment (prod or test)'
        required: true
        default: 'test'
      appName:
        description: 'app name'
        required: true
        default: 'app-demo'
      needScreengrab:
        description: 'need screengrab'
        required: true
        default: 'true'
      appUploadCommend:
        description: 'app upload commend'
        required: false
        default: ''

jobs:
  build:
    runs-on: macos-15
    timeout-minutes: 60
    permissions:
      contents: read
    steps:
      # 拉取配置代码
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Parse S3_SECRET
        id: parse
        if: ${{ github.event.inputs.environment == 'test' }}
        run: |
          # 使用管道避免写入文件系统
          env_file="fastlane_templates/.env"

          echo "AWS_ACCESS_KEY_ID=$(echo '${{ secrets.S3_SECRET }}' | jq -r '.aws_access_key_id')" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$(echo '${{ secrets.S3_SECRET }}' | jq -r '.aws_secret_access_key')" >> $GITHUB_ENV
          echo "AWS_REGION=$(echo '${{ secrets.S3_SECRET }}' | jq -r '.region_name')" >> $GITHUB_ENV
          echo "BUCKET_NAME=$(echo '${{ secrets.S3_SECRET }}' | jq -r '.bucket_name')" >> $GITHUB_ENV

          sed -i '' "s|^AWS_ACCESS_KEY_ID=.*|AWS_ACCESS_KEY_ID='${AWS_ACCESS_KEY_ID}'|" $ENV_FILE
          sed -i '' "s|^AWS_SECRET_ACCESS_KEY=.*|AWS_SECRET_ACCESS_KEY='${AWS_SECRET_ACCESS_KEY}'|" $ENV_FILE
          sed -i '' "s|^AWS_REGION=.*|AWS_REGION='${AWS_REGION}'|" $ENV_FILE
          sed -i '' "s|^BUCKET_NAME=.*|BUCKET_NAME='${BUCKET_NAME}'|" $ENV_FILE

      - name: Select Xcode 16.3
        run: sudo xcode-select -s /Applications/Xcode_16.3.app/Contents/Developer
      
      # 线上环境，下载项目源码
      - name: Download Expo source (for prod environment)
        if: ${{ github.event.inputs.environment == 'prod' }}
        run: |
          curl -L https://your-server.com/expo-source.zip -o app-demo.zip
          unzip app-demo.zip
      
  
      # 缓存 npm 安装结果，流程执行完的后续节点进行的缓存，如果流程执行失败，缓存会失败
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.2.0
          cache: 'npm'
          cache-dependency-path: './${{ github.event.inputs.appName }}/package-lock.json'
      
      # npm 安装依赖
      - name: Install dependencies
        run: |
          cd ${{ github.event.inputs.appName }}
          npm install        

      - name: Install applesimutils
        run: brew tap wix/brew && brew install applesimutils
        
      # 构建IOS源码
      - name: Build for iOS
        run: |
          cd ${{ github.event.inputs.appName }}
          npx expo prebuild --platform ios
         

      # 执行fastlane配置脚本
      - name: exec manage_fastlane.sh
        run: |
          ./manage_fastlane.sh ${{ github.event.inputs.appName }} ios
    
      # IOS包构建
      - name: ios build
        run: |
          cd ${{ github.event.inputs.appName }}/ios
          #./fastlane/deploy_ios.sh build_only
      
      #IOS 截屏
      - name: ios screengrab
        if: ${{ github.event.inputs.needScreengrab == 'true' }}
        run: |
          cd ${{ github.event.inputs.appName }}/ios
          ./fastlane/deploy_ios.sh screengrab

      # IOS 上传
      - name: ios appUpload
        if: ${{ github.event.inputs.appUploadCommend != '' }}
        run: |
          cd ${{ github.event.inputs.appName }}/ios
          ./fastlane/deploy_ios.sh ${{github.event.inputs.appUploadCommend}}
      
