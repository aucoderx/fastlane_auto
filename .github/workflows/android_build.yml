name: Expo android build and deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment (prod or test)'
        required: true
        default: 'test'
      appName:
        description: 'app name'
        required: true
        default: 'app-demo'
      needScreengrab:
        description: 'need screengrab'
        required: true
        default: 'true'
      appUploadCommend:
        description: 'app upload command'
        required: false
        default: ''
      testUserCacheAPK:
        description: 'use test apk'
        required: false
        default: 'false'

jobs:
    
    build-and-test-android:
        name: Android - Build and run Detox tests
        runs-on: ubuntu-latest
        timeout-minutes: 60
        permissions:
            contents: read

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                fetch-depth: 1

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 22.2.0
                cache: 'npm'
                cache-dependency-path: './${{ github.event.inputs.appName }}/package-lock.json'

            - name: Set up Ruby
              uses: ruby/setup-ruby@v1
              with:
                ruby-version: '3.4.5'
                bundler-cache: true # 这是一个重要的优化！

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                distribution: zulu
                java-version: 17
            
            - name: Install system dependencies
              run: |
                sudo apt-get update
                sudo apt-get install -y libpulse0

            # 线上环境，下载项目源码
            - name: Download Expo source (for prod environment)
              if: ${{ github.event.inputs.environment == 'prod' }}
              run: |
                curl -L https://your-server.com/expo-source.zip -o app-demo.zip
                unzip app-demo.zip
            
            # 测试环境，恢复谷歌服务账号
            - name: deal test env
              if: ${{ github.event.inputs.environment == 'test' }}
              run: |
                mkdir -p fastlane_templates/certificates/
                echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > fastlane_templates/certificates/google-play-service-account.json

            
            - name: Npm install
              run: |
                cd ${{ github.event.inputs.appName }}
                npm install


            # 构建安卓源码
            - name: Build for or Android
              run: |
                cd ${{ github.event.inputs.appName }}
                npx expo prebuild --platform android

            # 执行fastlane配置脚本
            - name: exec manage_fastlane.sh
              run: |
                ./manage_fastlane.sh ${{ github.event.inputs.appName }}

            # 构建安卓的apk包，Abb包(prod)
            - name: android build prod
              if: ${{ github.event.inputs.environment == 'prod' }}
              run: |
                cd ${{ github.event.inputs.appName }}/android
                ./fastlane/deploy_android.sh build_debug
                if [ ! -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
                    echo "app-debug.apk not exists"
                fi
                if [ ! -f "app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk" ]; then
                    echo "app-debug-androidTest.apk not exists"
                fi
            
            # 构建安卓的apk包，Abb包
            - name: android build test
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              if: ${{ github.event.inputs.environment == 'test' }}
              run: |
                if [ "${{ github.event.inputs.testUserCacheAPK }}" == "false" ]; then
                    cd ${{ github.event.inputs.appName }}/android
                    ./fastlane/deploy_android.sh build_debug
                    if [ ! -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
                    echo "app-debug.apk not exists"
                    fi
                    if [ ! -f "app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk" ]; then
                    echo "app-debug-androidTest.apk not exists"
                    fi
                else
                    cd ${{ github.event.inputs.appName }}/android
                    
                    mkdir -p app/build/outputs/apk/debug
                    mkdir -p app/build/outputs/apk/androidTest/debug

                    TAG="v1.0.0-data"

                    gh release download $TAG --pattern 'app-debug.apk' --clobber
                    gh release download $TAG --pattern 'app-debug-androidTest.apk' --clobber

                    mv app-debug.apk app/build/outputs/apk/debug/app-debug.apk
                    mv app-debug-androidTest.apk app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk
                    
                    ls -lR app/build/outputs/apk/
                fi
            
 
            # - name: Start Metro server
            #   run: |
            #     cd ${{ github.event.inputs.appName }}
            #     echo "Starting Metro server..."
            #     echo "Current directory: $(pwd)"
            #     echo "Node version: $(node --version)"
            #     echo "NPM version: $(npm --version)"
                
            #     # 启动 Metro 服务器并保存日志
            #     npx react-native start --port 8081 > metro.log 2>&1 &
            #     METRO_PID=$!
            #     echo "Metro server started with PID: $METRO_PID"
            #     echo "METRO_PID=$METRO_PID" >> $GITHUB_ENV
                
            #     # 等待 Metro 服务器启动
            #     echo "Waiting for Metro server to be ready..."
            #     for i in {1..60}; do
            #       if curl -f http://localhost:8081/status > /dev/null 2>&1; then
            #         echo "Metro server is ready after ${i} seconds"
            #         break
            #       fi
            #       echo "Attempt $i: Metro server not ready yet, waiting..."
            #       sleep 2
            #     done
                
            #     # 检查 Metro 状态
            #     if curl -f http://localhost:8081/status > /dev/null 2>&1; then
            #       echo "Metro server status check: SUCCESS"
            #       curl -s http://localhost:8081/status || echo "Could not get status details"
            #     else
            #       echo "Metro server status check: FAILED"
            #       echo "=== Metro Log (last 50 lines) ==="
            #       tail -50 metro.log || echo "Could not read metro.log"
            #       echo "========================="
            #     fi
                
            #     # 显示端口占用情况
            #     echo "=== Port 8081 Status ==="
            #     netstat -tlnp | grep :8081 || echo "Port 8081 not listening"
            #     lsof -i :8081 || echo "No process found on port 8081"

            - name: Run Detox tests
              uses: reactivecircus/android-emulator-runner@v2
              with:
                api-level: 30
                arch: x86_64
                    # 添加磁盘空间配置
                disk-size: 6144M  # 增加磁盘空间
                heap-size: 2048M  # 增加堆内存
                ram-size: 3072M   # 增加RAM
                avd-name: Android_API30
                force-avd-creation: false
                emulator-options: -no-snapshot-save -no-window -gpu off -no-audio -no-boot-anim -camera-back -no-skin -no-metrics
                disable-animations: true
                script: |
                    # Wait for package manager to be ready
                    adb wait-for-device
                    adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
                    adb shell 'while [[ -z $(getprop dev.bootcomplete) ]]; do sleep 1; done'
                    # Additional wait for package manager
                    timeout 300 bash -c 'until adb shell pm list packages > /dev/null 2>&1; do sleep 5; done'
                    cd ${{ github.event.inputs.appName }}/android && ./fastlane/deploy_android.sh screengrab
          
        # 在你的 workflow 文件中，在 Detox 测试步骤之后添加这个步骤

            - name: Upload Screenshots and Logs
              if: always()  
              uses: actions/upload-artifact@v4
              with:
                name: detox-debug-artifacts
                path: |
                  ${{ github.event.inputs.appName }}/artifacts/**/*.png
                  # ${{ github.event.inputs.appName }}/detox_*.log
                  # ${{ github.event.inputs.appName }}/metro.log
                retention-days: 7
          
        # 还可以添加一个步骤来显示截图信息
            - name: List Generated Screenshots
              if: always()
              run: |
                echo "=== Generated Screenshots ==="
                find ${{ github.event.inputs.appName }} -name "*.png" -type f -exec ls -la {} \; || echo "No screenshots found"
                
                echo "=== Detox Artifacts Directory ==="
                ls -la ${{ github.event.inputs.appName }}/artifacts/ || echo "No artifacts directory"